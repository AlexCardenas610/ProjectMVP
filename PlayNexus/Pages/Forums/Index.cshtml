@page
@model PlayNexus.Pages.Forums.IndexModel
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<h1>Forums</h1>

<form method="post">
    <div class="form-group">
        <label for="Topic">Topic</label>
        <input type="text" id="Topic" name="Topic" class="form-control" required />
    </div>
    <div class="form-group">
        <label for="PostContent">Post Content</label>
        <textarea id="PostContent" name="PostContent" class="form-control" rows="4" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Create Post</button>
</form>

<hr />

<h2>Existing Topics and Posts</h2>

@if (Model.Posts != null && Model.Posts.Any())
{
    <ul>
        @foreach (var forum in Model.Posts)
        {
            <li>
                <h3>@forum.Topic</h3>
                <div><b>@forum.UserName</b> (@forum.CreatedAt.ToShortDateString()): @forum.Content</div>
                @if (!string.IsNullOrEmpty(User?.Identity?.Name) && User.Identity.Name != forum.UserName)
                {
                    <form method="post" asp-page-handler="Reply" asp-route-forumId="@forum.Id">
                        <div class="form-group">
                            <label for="ReplyContent_@forum.Id">Reply</label>
                            <textarea id="ReplyContent_@forum.Id" name="ReplyContent" class="form-control" rows="2" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-success mt-1">Reply</button>
                    </form>
                }
                @if (!string.IsNullOrEmpty(User?.Identity?.Name) && User.Identity.Name == forum.UserName)
                {
                    <form method="post" asp-page-handler="Delete" asp-route-forumId="@forum.Id" onsubmit="return confirm('Are you sure you want to delete this post?');">
                        <button type="submit" class="btn btn-danger btn-sm mt-1">Delete</button>
                    </form>
                    <form method="get" asp-page="Edit" asp-route-forumId="@forum.Id">
                        <button type="submit" class="btn btn-warning btn-sm mt-1">Edit</button>
                    </form>
                }
                <div class="mt-2">
                    <strong>Replies:</strong>
                    <ul>
                        @foreach (var reply in forum.Replies)
                        {
                            <li><b>@reply.UserName</b> (@reply.CreatedAt.ToShortDateString()): @reply.Content</li>
                        }
                    </ul>
                </div>
            </li>
        }
    </ul>
}
else
{
    <p>No forum posts yet.</p>
}
